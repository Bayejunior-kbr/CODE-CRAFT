#include <stdio.h>
#include <time.h>
#include <windows.h>

// Structure pour une vente
typedef struct {
    char nom[30];
    float prix;

    int quantite;
} Vente;

// Charger les ventes depuis ventes.txt
int chargerVentes(Vente ventes[], int max) {
    FILE *fichier = fopen("ventes.txt", "r");
    if (fichier == NULL) {
        printf("\033[1;31m[ERREUR] Impossible d'ouvrir ventes.txt.\033[0m\n");
        return 0;
    }

    int i = 0;
    while (i < max && fscanf(fichier, "%s %f %d", ventes[i].nom, &ventes[i].prix, &ventes[i].quantite) == 3) {
        i++;
    }

    fclose(fichier);
    return i;
}

// Fonction principale de génération du rapport
int genererRapport() {
    printf("\033[1;33m[*] Generation du rapport");
    for (int i = 0; i < 3; i++) {
        Sleep(300);
        printf(".");
    }
    printf("\033[0m\n");

    // Date
    char nomFichier[100];
    time_t maintenant = time(NULL);
    struct tm *date = localtime(&maintenant);
    strftime(nomFichier, sizeof(nomFichier), "ETAT_%Y%m%d.txt", date);

    Vente ventes[50];
    int nb = chargerVentes(ventes, 50);

    float total = 0;
    int quantiteTotale = 0;
    for (int i = 0; i < nb; i++) {
        total += ventes[i].prix * ventes[i].quantite;
        quantiteTotale += ventes[i].quantite;
    }

    FILE *fichier = fopen(nomFichier, "w");
    if (fichier == NULL) {
        printf("\033[1;31m[ERREUR] Impossible de creer le fichier.\033[0m\n");
        return 1;
    }

    fprintf(fichier, "=========== RAPPORT JOURNALIER ===========\n");
    fprintf(fichier, "Date : %02d/%02d/%d\n", date->tm_mday, date->tm_mon + 1, date->tm_year + 1900);
    fprintf(fichier, "Total : %.2f XOF\n", total);
    fprintf(fichier, "Medicaments vendus : %d\n", quantiteTotale);
    fprintf(fichier, "===========================================\n");
    fclose(fichier);

    // Résumé à l'écran
    printf("\n\033[1;36m+=============================+\033[0m\n");
    printf("\033[1;36m|       RAPPORT DU JOUR       |\033[0m\n");
    printf("\033[1;36m+=============================+\033[0m\n");
    printf("Total ventes : %.2f XOF\n", total);
    printf("Articles vendus : %d\n\n", quantiteTotale);

    // Tableau visuel
    printf("\033[1;34m+----------------------+--------+----------+\033[0m\n");
    printf("\033[1;34m| Medicament           | Prix   | Qte      |\033[0m\n");
    printf("\033[1;34m+----------------------+--------+----------+\033[0m\n");
    for (int i = 0; i < nb; i++) {
        printf("| %-20s | %6.0f | %8d |\n", ventes[i].nom, ventes[i].prix, ventes[i].quantite);
    }
    printf("\033[1;34m+----------------------+--------+----------+\033[0m\n");

    printf("\033[1;32m[OK] Rapport journalier enregistre.\033[0m\n");
    return 0;
}
