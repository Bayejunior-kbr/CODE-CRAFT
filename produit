typedef struct{
    char code[6];
    char designation[30];
    int prix;
    int quantite;
    int categorie;
    char date_p[20];
}PRODUIT;
void menu();
void menuProduits();
void ajouteproduit();
void modifieproduit();
void supprimeproduit();
void rechercheproduit();
void listeproduit();
void menuprincipal();



#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include "exam.h"
#include "categorie.h"
#include "user.h"
#include "vente.h"


#define RESET   "\x1b[0m"
#define RED     "\x1b[31m"
#define GREEN   "\x1b[32m"
#define YELLOW  "\x1b[33m"
#define BLUE    "\x1b[34m"
#define CYAN    "\x1b[36m"
#define MAGENTA "\x1b[35m"
#define WHITE   "\x1b[37m"



PRODUIT p;
FILE *pd;


void menu() {
    printf("\x1b[36mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n\x1b[0m");
    printf("\x1b[32mâ•‘       *** Gestion des Produits ***   â•‘\n\x1b[0m");
    printf("\x1b[36mâ• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n\x1b[0m");


    printf("â•‘ \x1b[36m1.\x1b[33m Ajouter un produit                \x1b[0mâ•‘\n");
    printf("â•‘ \x1b[36m2.\x1b[33m Modifier un produit               \x1b[0mâ•‘\n");
    printf("â•‘ \x1b[36m3.\x1b[33m Supprimer un produit              \x1b[0mâ•‘\n");
    printf("â•‘ \x1b[36m4.\x1b[33m Rechercher un produit             \x1b[0mâ•‘\n");
    printf("â•‘ \x1b[36m5.\x1b[33m Afficher la liste des produits    \x1b[0mâ•‘\n");
    printf("â•‘ \x1b[31m6.\x1b[33m Retour au menu principal          \x1b[0mâ•‘\n");


    printf("\x1b[36mâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\x1b[0m");

    printf("Choix : ");
}





void printproduit(){
do {
        printf("Donner le code du produit (5 caractÃ¨res) : ");
        scanf("%s", p.code);
        if (strlen(p.code) != 5) {
            printf("[ERREUR] Le code doit avoir exactement 5 caractÃ¨res.\n");
        }
} while (strlen(p.code) != 5);
printf("Donner la designation du produit : ");
scanf(" %s",&p.designation);
do{
printf("Donner le prix du produit : ");
scanf("%d",&p.prix);
}while(p.prix<=0);
do{
printf("Donner laquantite du produit : ");
scanf("%d",&p.quantite);
}while(p.quantite<=0);
do{
printf("Donner la categorie du produit : ");
scanf("%d",&p.categorie);
}while(p.categorie<=0);
printf("Donner la date de peremtion(aaaa/mm/jj) : ");
scanf(" %s",&p.date_p);
}



void produit(){
do {
        printf("Donner le nouvelle code du produit (5 caractÃ¨res) : ");
        scanf("%s", p.code);
        if (strlen(p.code) != 5) {
        printf("[ERREUR] Le code doit avoir exactement 5 caractÃ¨res.\n");
        }
} while (strlen(p.code) != 5);
printf("Donner la nouvelle designation du produit : ");
scanf(" %s",&p.designation);
do{
printf("Donner le nouveau prix du produit : ");
scanf("%d",&p.prix);
}while(p.prix<=0);
do{
printf("Donner la nouvelle quantite du produit : ");
scanf("%d",&p.quantite);
}while(p.quantite<=0);
do{
printf("Donner la nouvelle categorie du produit : ");
scanf("%d",&p.categorie);
}while(p.categorie<=0);
printf("Donner la nouvelledate de peremtion(aaaa/mm/jj) : ");
scanf(" %s",&p.date_p);
}




void verification(FILE * pd){
if(pd==NULL){
    puts("le fichier n'est pas ouverts");
    exit(1);
}
}



void ajouteproduit(){
     animationChargement("\x1b[36mğŸ”· Chargement du module ajou-produit\x1b[0m");
    printproduit();
    pd=fopen("PRODUIT.dat","a+");
    verification(pd);
    fprintf(pd,"%s\t %s\t %d\t %d\t %d\t %s\t",p.code,p.designation,p.prix,p.quantite,p.categorie,p.date_p);
    puts(" PRODUIT AJOUTER AVEC SUCCES");
    fclose(pd);
}




void modifieproduit(){
     animationChargement("\x1b[36mğŸ”· Chargement du module modifier-produit\x1b[0m");
    int verif=0;
    char code[6];
    printf("entre le code rechercher : ");
    scanf("%s",&code);
    pd=fopen("PRODUIT.dat","r");
    FILE * tmp=fopen("tmp.dat","w");
    verification(tmp);
    verification(pd);
    while(fscanf(pd,"%s\n %s\n %d\n %d\n %d\n %s\n",p.code,p.designation,&p.prix,&p.quantite,&p.categorie,p.date_p)==6){
        if(strcmp(code, p.code) == 0){
            verif   =  1;
            produit();
    }
         fprintf(tmp,"%s\n %s\n %d\n %d\n %d\n %s\n",p.code,p.designation,p.prix,p.quantite,p.categorie,p.date_p);
    }
    fclose(tmp);
    fclose(pd);
    remove("PRODUIT.dat");
    rename("tmp.dat","PRODUIT.dat");
    (verif)?printf("Produit modifier avec succes"):printf("produit n'exite pas");
}



void supprimeproduit(){
     animationChargement("\x1b[36mğŸ”· Chargement du module supprimer-produit\x1b[0m");
 int verif=0;
    char code[6];
    printf("entre le code rechercher : ");
    scanf("%s",&code);
    pd=fopen("PRODUIT.dat","r");
    FILE * tmp=fopen("tmp.dat","w");
    verification(tmp);
    verification(pd);
     while(fscanf(pd,"%s\n %s\n %d\n %d\n %d\n %s\n",p.code,p.designation,&p.prix,&p.quantite,&p.categorie,p.date_p)==6){
        if(strcmp(code, p.code) == 0){
            verif= 1;
        }else{
         fprintf(tmp,"%s\n %s\n %d\n %d\n %d\n %s\n",p.code,p.designation,p.prix,p.quantite,p.categorie,p.date_p);
    }

}
    fclose(tmp);
    fclose(pd);
    remove("PRODUIT.dat");
    rename("tmp.dat","PRODUIT.dat");
    (verif)?printf("\nProduit supprimer avec succes\n"):printf("\n produit n'exite pas \n");
}

void rechercheproduit(){
     animationChargement("\x1b[36mğŸ”· Chargement du module recherce-produit\x1b[0m");
    int trouve=0;
     char code[6];
    printf("entre le code rechercher : ");
    scanf("%s",&code);
    pd=fopen("PRODUIT.dat","r");
    verification(pd);
     printf("\n%-6s %-20s %-8sXOF %-10s %-10s %-12s\n",
           "Code", "Designation", "Prix(XOF)", "Quantite", "Categorie", "Peremption");
    printf("-------------------------------------------------------------------------------\n");

    while (fscanf(pd, "%s\n %s\n %d\n %d\n %d\n %s\n",
                  p.code, p.designation, &p.prix, &p.quantite, &p.categorie, p.date_p) == 6) {
        if (strcmp(code, p.code) == 0) {
            printf("%-6s %-20s %-8d %-10d %-10d %-12s\n",
                   p.code, p.designation, p.prix, p.quantite, p.categorie, p.date_p);
            trouve = 1;
            break;
        }
    }
      if(trouve) {
        printf("\nProduit trouve avec succes.\n");
    } else {
        printf("Produit inexistant.\n");
    }
    fclose(pd);
}






void listeProduit() {
     animationChargement("\x1b[36mğŸ”· Chargement du module Listes produit\x1b[0m");
    FILE *pd = fopen("PRODUIT.dat", "r");
    verification(pd);


    printf("\x1b[36mâ•”â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n\x1b[0m");
    printf("\x1b[32mâ•‘ Code   â•‘ Designation        â•‘ Prix     â•‘ Quantite â•‘ Categorieâ•‘ Peremption   â•‘\n\x1b[0m");
    printf("\x1b[36mâ• â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n\x1b[0m");

    while (fscanf(pd, "%s\n %s\n %d\n %d\n %d\n %s\n",
                  p.code, p.designation, &p.prix, &p.quantite, &p.categorie, p.date_p) == 6) {
        printf("\x1b[33mâ•‘ %-6s â•‘ %-18s â•‘ %-8d â•‘ %-8d â•‘ %-8d â•‘ %-12s â•‘\n\x1b[0m",
               p.code, p.designation, p.prix, p.quantite, p.categorie, p.date_p);
    }

    printf("\x1b[36mâ•šâ•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\x1b[0m");

    fclose(pd);
}






void menuPrincipal(const char* role) {
    int choix;
    do {
        system("cls");
        printf(CYAN "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n" RESET);
        printf(CYAN "â•‘" RESET);
        printf(GREEN "        ğŸŒŸ PHARMACIE SUNUPHARMA ğŸŒŸ              " RESET);
        printf(CYAN "â•‘\n" RESET);
        printf(CYAN "â•‘" RESET);
        printf(GREEN "            GESTION DU STOCK & VENTES           " RESET);
        printf(CYAN "â•‘\n" RESET);
        printf(CYAN "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n" RESET);

        if (strcmp(role, "ADMIN") == 0) {
            printf(CYAN "â•‘ " RESET);
            printf(YELLOW "1. ğŸ“¦  GÃ©rer les produits                      " RESET);
            printf(CYAN "â•‘\n" RESET);

            printf(CYAN "â•‘ " RESET);
            printf(YELLOW "2. ğŸ—‚ï¸  GÃ©rer les catÃ©gories                    " RESET);
            printf(CYAN "â•‘\n" RESET);

            printf(CYAN "â•‘ " RESET);
            printf(YELLOW "3. ğŸ‘¥  GÃ©rer les utilisateurs                  " RESET);
            printf(CYAN "â•‘\n" RESET);
        }

        if (strcmp(role, "PHAR") == 0) {
            printf(CYAN "â•‘ " RESET);
            printf(YELLOW "4. ğŸ’°  Gestion des ventes                      " RESET);
            printf(CYAN "â•‘\n" RESET);

            printf(CYAN "â•‘ " RESET);
            printf(YELLOW "5. ğŸ“„  Rapport journalier                      " RESET);
            printf(CYAN "â•‘\n" RESET);
        }

        printf(CYAN "â•‘ " RESET);
        printf(RED "6. âŒ  Quitter                                 " RESET);
        printf(CYAN "â•‘\n" RESET);

        printf(CYAN "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n" RESET);

        printf("Votre choix : ");
        scanf("%d", &choix);

        if (strcmp(role, "ADMIN") == 0) {
            switch (choix) {
                case 1: menuProduits(); break;
                case 2: menuCategorie(); break;
                case 3: menuUtilisateurs(); break;
                case 6:
                    printf(GREEN "\nMerci d'avoir utilisÃ© l'application. Ã€ bientÃ´t !\n" RESET);
                    break;
                default:
                    printf(RED "\n[!] Choix invalide, rÃ©essayez.\n" RESET);
                    break;
            }
        } else if (strcmp(role, "PHAR") == 0) {
            switch (choix) {
                case 4: menuVentes(); break;
                case 5: menuRapport(); break;
                case 6:
                    printf(GREEN "\nMerci d'avoir utilisÃ© l'application. Ã€ bientÃ´t !\n" RESET);
                    break;
                default:
                    printf(RED "\n[!] Choix invalide, rÃ©essayez.\n" RESET);
                    break;
            }
        }

        if (choix != 6) {
            printf("\nAppuyez sur EntrÃ©e pour continuer...");
            getchar(); getchar();
        }

    } while (choix != 6);
}








void animationChargement(const char *texte) {
    printf("%s", texte);
    for (int i = 0; i < 3; i++) {
        Sleep(300);
        printf(".");
        fflush(stdout);
    }
    printf("\n");
}

void menuProduits() {
    int choice;
    animationChargement(" Ouverture du module Produits");

    do {
        menu();

        scanf("%d", &choice);
        switch(choice) {
            case 1: ajouteproduit(); break;
            case 2: modifieproduit(); break;
            case 3: supprimeproduit(); break;
            case 4: rechercheproduit(); break;
            case 5: listeProduit(); break;
            case 6: printf("Retour au menu principal...\n"); break;
            default: printf("Choix invalide.\n"); break;
        }
    } while(choice != 6 && choice != 7);
}

